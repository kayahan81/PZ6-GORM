---
# Практическое задание 6

## ЭФМО-02-25 

## Алиев Каяхан Командар оглы
---
# Информация о проекте
Использование ORM (GORM). Модели, миграции и связи между таблицами.

## Цели занятия
-	Понять, что такое ORM и чем удобен GORM.
-	Научиться описывать модели Go-структурами и автоматически создавать таблицы (миграции через AutoMigrate).
-	Освоить базовые связи: 1:N и M:N + выборки с Preload.
-	Написать короткий REST (2–3 ручки) для проверки результата.

## Файловая структура проекта:

<img width="1109" height="537" alt="image" src="https://github.com/user-attachments/assets/72e9cd19-f98a-479b-be18-23ab140c91cb" />


## Ключевые компоненты

cmd/server/main.go — Точка входа приложения инициализация подключения к базе данных через db.Connect(), выполнение автоматических миграций для моделей (AutoMigrate), сборка HTTP-роутера и запуск сервера на порту 8080.

internal/db/postgres.go — Модуль подключения к базе данных

internal/models/models.go — Доменные модели для GORM: определение структур данных (User, Note, Tag) с полями, GORM-тегами (ограничения, индексы) и декларацией связей между таблицами (1:N — User → []Note, M:N — Note ↔ Tag через таблицу note_tags).

internal/http/router.go — Конфигуратор HTTP-роутера для создания роутера Chi, инициализации обработчиков и регистрации маршрутов для эндпоинтов /health, /users, /notes и /notes/{id}.

internal/http/handlers.go — Обработчики HTTP-запросов создания пользователей (CreateUser) и заметок (CreateNote), получения заметок с полной информацией (GetNoteByID), включая обработку входных данных, взаимодействие с БД через GORM и формирование JSON-ответов.

go.mod - файл модуля Go: описание зависимостей, версия Go, имя модуля

# Примечания по конфигурации и требования

Для запуска требуется:

Go: версия 1.25.1

PostgreSQL: версия не ниже 14

<img width="841" height="232" alt="Установка Git и Go" src="https://github.com/user-attachments/assets/8e01d831-5a7f-4376-8348-9052b240aec9" />


# Команды запуска/сборки
Для запуска http нужно выполнить 4 шага:
## 1) Клонировать данный репозиторий в удобную для вас папку:
```Powershell
git clone https://github.com/kayahan81/PZ5-baza
```
## 2) Перейти в папку http:
```Powershell
cd PZ6-GORM
```
## 3) Загрузка зависимостей:
```Powershell
go mod tidy
```
## 4) Команда запуска
```Powershell
$env:DB_DSN="host=127.0.0.1 user=postgres password=postgres dbname=pz6_gorm port=5432 sslmode=disable"
go run ./cmd/server
```

#Коды ответа

201 Created — создание User/Note
200 OK — GET с Preload
400 Bad Request — валидация
404 Not Found — ресурс не найден
409 Conflict — unique violation

# Команда сборки
Для сборки бинарника и запуска .exe файла используются данные программы

```Powershell
go build -o server.exe .
server.exe
```
# Проверка работоспособности

## Базовый функционал

Запуск сервера

<img width="1454" height="102" alt="image" src="https://github.com/user-attachments/assets/7360e66e-7f40-4882-b4b2-cab1f909a2dc" />

## Проверка "ручек"

Здоровье

<img width="1434" height="529" alt="image" src="https://github.com/user-attachments/assets/bb1a6340-f542-4485-9d5d-f741645f6d60" />

Создание пользователя

<img width="1459" height="563" alt="image" src="https://github.com/user-attachments/assets/daf676fb-b3b3-4500-8135-2bcc5434437e" />

Создание заметок

<img width="1458" height="397" alt="image" src="https://github.com/user-attachments/assets/4bc11e45-1b01-4eee-bb85-9c3d25a078d7" />

Просмотр заметки

<img width="1454" height="546" alt="image" src="https://github.com/user-attachments/assets/72803c2d-ce16-4722-976b-91223528ff89" />

База данных 

<img width="703" height="424" alt="image" src="https://github.com/user-attachments/assets/7508f91c-d63c-408d-b643-65f50856dca2" />

#Ответы на вопросы

##1. Что такое ORM и зачем она нужна, если есть database/sql?
ORM — это прослойка, которая преобразует объекты кода в таблицы БД и обратно, позволяя разработчику думать в терминах структур, а не SQL. Она нужна для ускорения разработки стандартных CRUD-операций и повышения безопасности за счёт автоматической параметризации запросов.

+ ускоряет разработку за счёт сокращения шаблонного SQL-кода
+ повышает безопасность, автоматически защищая от SQL-инъекций через параметризацию.

- может работать медленнее ручного SQL на сложных запросах
- часто требует написания сырого SQL для агрегаций, оконных функций или специфичной оптимизации.

##2. Как в GORM описать связи 1:N и M:N? Какие теги на полях вы использовали?
Связь 1:N описывается добавлением среза дочерних структур в родительскую модель (например, []Note в User). Связь M:N описывается с помощью тега gorm:"many2many:note_tags;" на срезах связанных структур в обеих моделях.

##3. Что делает AutoMigrate? В каких случаях его недостаточно?
AutoMigrate автоматически создаёт или обновляет таблицы БД в соответствии со структурами Go. Его недостаточно, когда требуется удаление полей, изменение типов существующих колонок или выполнение сложных миграций с данными.

##4. Чем Preload отличается от обычного Find/First? Когда его применять?
Preload загружает связанные данные (реляционные связи) вместе с основной сущностью за отдельный запрос. Его нужно применять всегда, когда в результате необходимы данные из связанных таблиц, чтобы избежать проблемы N+1 запроса.

##5. Как в GORM обработать ошибку нарушения уникального индекса? Что вернёт БД/драйвер?
При нарушении уникального индекса GORM вернёт ошибку, которую можно проверить через db.Error. БД/драйвер возвращает ошибку типа pq: duplicate key value violates unique constraint, которую GORM оборачивает в свою структуру ошибки.
